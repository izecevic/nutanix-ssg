{"status":{},"contains_secrets":true,"product_version":"3.3.1","spec":{"description":"","resources":{"endpoints_information":[],"endpoint_definition_list":[],"client_attrs":{},"credential_definition_list":[],"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"GenerateNutanixVar"},{"kind":"app_task","name":"CreateVM"}],"name":"324150a2_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"GenerateNutanixVar"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"CreateVM"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_endpoint","name":"endpoint_ecn"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"GenerateNutanixVar","attrs":{"script":"# generate nutanix_vars.yml\n\necho \"\nVMsTable:\n  - vm:\n    Identifiant Serveur: \"@@{identifiant_serveur}@@\"\n    Hostname: \"@@{hostname}@@\"\n    Nom VM: \"@@{nom_vm}@@\"\n    Cluster_data: \"@@{cluster_data}@@\"\n    Description: \"@@{description}@@\"\n    Golden_image: \"@@{golden_image}@@\"\n    R\u00e9seau 01: \"@@{reseau01}@@\"\n    R\u00e9seau 02: \"N\/A\"\n    Range 01: \"@@{reseau01_range}@@\"\n    Range 02: \"N\/A\"\n    Coeurs physiques: \"@@{num_vcpus}@@\"\n    RAM: \"$(((@@{num_memory}@@)*1024))\"\" > \/home\/deploy\/nutanix_vars.yml\n","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_endpoint","name":"endpoint_ecn"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"CreateVM","attrs":{"script":"#!\/usr\/bin\/env bash\n\nsource \/home\/deploy\/nutanixrc\n\nTF_VAR_pg_ssl_path=\"$HOME\/.config\/refdata\"\n\nworkDir=$(pwd)\n\necho -n \"V\u00e9rification des certificats...\"\nif ls \"\/opt\/certificats\" | grep \".p12\" >\/dev\/null 2>&1\nthen\n    echo \"Succ\u00e8s\"\nelse\n    echo \"WARNING : Aucun certificat trouv\u00e9 dans \/opt\/certificats.\"\nfi\n\necho -n \"V\u00e9rification des certificats client Refdata...\"\nif ls \"$TF_VAR_pg_ssl_path\" | grep \"refdata-client\" >\/dev\/null 2>&1\nthen\n    echo \"Succ\u00e8s\"\nelse\n    echo \"WARNING : Aucun certificat trouv\u00e9 dans $TF_VAR_pg_ssl_path.\"\nfi\n\necho -n \"V\u00e9rification du statut Kerberos...\"\nif klist | grep \"Default\" >\/dev\/null 2>&1\nthen\n    echo \"Succ\u00e8s\"\nelse\n    echo \"Le jeton Kerberos a expir\u00e9.\"\n    echo \"Se d\u00e9connecter puis reconnecter \u00e0 la VM pour avoir un jeton valide.\"\n    exit 1\nfi\n\n#TODO r\u00e9cup\u00e9rer cette valeur \u00e0 partir du fichier static\nrepoName=\"siadmin-t1-cdb_rebond_01\"\n\nrepo=\"$HOME\/$repoName\"\norg=$(echo ${repoName} | cut -d '_' -f 1)\nbuilding_block=$(echo ${repoName} | cut -d \"_\" -f 1 --complement | rev | cut -d \"_\" -f 1 --complement | rev)\n\nfunction sortie () {\n    git add .\n    git commit -q --allow-empty -m \"D\u00e9ploiement : $2\"\n    git push -q\n\n    cd ${workDir}\n    rm -rf ${repo}\n\n    exit $1\n}\n\n#On teste l'existance du repo en remote\nif git ls-remote https:\/\/refdep\/${org}\/${repoName}.git >\/dev\/null 2>&1\nthen\n    echo \"Le d\u00e9pot existe => mise \u00e0 jour...\"\n    git clone https:\/\/refdep\/${org}\/${repoName}.git ${repo} -q\nelse\n    if [ ! -f \"$HOME\/.config\/gitearc\" ]\n    then\n        echo \"Le fichier $HOME\/.config\/gitearc n'existe pas.\"\n        echo \"Consultez la documentation pour les instructions.\"\n        exit 1\n    fi\n    echo \"Le d\u00e9pot n'existe pas => initialisation...\"\n    \/opt\/giteacli.sh new ${org}\/${repoName}\n    git clone https:\/\/refdep\/${org}\/${repoName}.git ${repo} -q\nfi\n\n#On place les nouveaux fichiers terraform dans le repo\n#python3 -m dosdepgen dosdep --file \"$filePath\" --target \"$HOME\"\ncd \/usr\/local\/lib\/python3.6\/site-packages\/dosdepgen\/templates\/dosdep\/nutanix\nansible-playbook -e @\/home\/deploy\/rebond_dependances.yml -e @\/home\/deploy\/rebond_parametres.yml -e @\/home\/deploy\/rebond_relations.yml -e @\/home\/deploy\/static_vars.yml -e @\/home\/deploy\/nutanix_vars.yml  -i localhost, main.yml\ncp \/tmp\/*.tf $repo\n\n#On commit les nouveaux fichiers\ncd ${repo}\nif [ ! -f .gitignore ]; then echo \".terraform\" > .gitignore; fi\ngit add .\necho -e \"\\nRaison de cette op\u00e9ration de d\u00e9ploiement :\"\nversion=$(grep -m1 \"$building_block.git\" main.tf | rev | cut -d \"?\" -f 1 | cut -d \"=\" -f 1 | cut -c 2- | rev)\ngit commit -q --allow-empty -m \"D\u00e9ploiement : d\u00e9marrage (version $version) - dep nutanix\"\ngit push -q --set-upstream origin master\n\n#On ex\u00e9cute le terraform\nterraform init -backend-config=\"conn_str=$REFDATA_CONN_STR\" -plugin-dir=\/opt\/terraform\/plugins\nif [[ $? == 1 ]]; then echo \"Erreur => abandon du d\u00e9ploiement.\"; sortie 1 \"Erreur lors de l'initialisation Terraform\"; fi\nterraform workspace delete ${repoName} || true\nterraform workspace new ${repoName} || true\nterraform workspace select ${repoName}\nterraform init -upgrade -plugin-dir=\/opt\/terraform\/plugins -backend=false\nterraform apply --auto-approve\nif [[ $? == 1 ]]; then echo \"Erreur => abandon du d\u00e9ploiement.\"; sortie 1 \"Erreur lors de la cr\u00e9ation de l'instance\"; fi\n\necho \"D\u00e9ploiement r\u00e9ussi.\"\nsortie 0 \"Succ\u00e8s\"","type":"","command_line_args":"","exit_status":[],"script_type":"sh"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"789f7dd6_runbook","main_task_local_reference":{"kind":"app_task","name":"324150a2_dag"},"variable_list":[{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"identifiant_serveur","value":"rad","label":"Identifiant Serveur","attrs":{"type":"LOCAL"},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":["rad","skype","exchange"]}},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"hostname","value":"sontx-mcdbwk01v","label":"Hostname","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"nom_vm","value":"RAD-CALM-1","label":"Nom VM","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"regex":{"should_validate":false,"value":"^.*$"},"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"cluster_data","value":"theatre","label":"Nom du cluster Nutanix","attrs":{"type":"LOCAL"},"editables":{"value":false},"is_hidden":true,"options":{"type":"PREDEFINED","choices":["theatre"]}},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"description","value":"lkjklj","label":"","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"golden_image","value":"win2016std_anv-dsagent_v0.7.2_sysprep_virtio_disk0_scsi_ecn","label":"Image","attrs":{"type":"LOCAL"},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":["win2016std_anv-dsagent_v0.7.2_sysprep_virtio_disk0_scsi_ecn"]}},{"regex":{"should_validate":false,"value":"^[\\d]*$"},"val_type":"INT","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"num_vcpus","value":"1","label":"Nombre de vCPUs","attrs":{"type":"LOCAL"},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":["1","2","4"]}},{"regex":{"should_validate":false,"value":"^[\\d]*$"},"val_type":"INT","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"num_memory","value":"2","label":"Memoire en GB","attrs":{"type":"LOCAL"},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":["2","4","8"]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"reseau01","value":"INFRA","label":"Reseau 01","attrs":{"type":"LOCAL"},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":["PROD","INFRA"]}},{"regex":{"should_validate":false,"value":"^.*$"},"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"EXEC_LOCAL","name":"reseau01_range","value":"R_INFRA\n","label":"Reseau 01 Range","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"EXEC","attrs":{"script":"reseau01 = \"@@{reseau01}@@\"\nprint \"R_{}\".format(reseau01)","type":"EXEC","command_line_args":"","exit_status":[],"script_type":"static"}}},{"regex":{"should_validate":true,"value":"^.*$"},"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"disk_size_2","value":"N\/A","label":"Disque 2 en GB","attrs":{"type":"LOCAL"},"editables":{"value":false},"is_hidden":true,"options":{"type":"PREDEFINED","choices":[]}},{"regex":{"should_validate":false,"value":"^.*$"},"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"disk_size_3","value":"N\/A","label":"Disque 3 en GB","attrs":{"type":""},"editables":{"value":false},"is_hidden":true,"options":{"type":"PREDEFINED","choices":[]}}]}},"name":"GeneratVarFileforECN"},"api_version":"3.0","metadata":{"last_update_time":"1673004225315130","kind":"runbook","spec_version":2,"creation_time":"1673004188973707","name":"GeneratVarFileforECN"}}